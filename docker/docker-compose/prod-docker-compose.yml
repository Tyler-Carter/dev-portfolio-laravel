services:
  app:
    env_file:
      - ../../.env
    build:
      context: ../..
      dockerfile: docker/dockerfiles/Dockerfile.prod
    image: dev-portfolio-laravel:prod
    restart: unless-stopped
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      DB_CONNECTION: pgsql
      DB_HOST: "${DB_HOST}"
      DB_PORT: "5432"
      DB_DATABASE: "${DB_DATABASE:-dev_portfolio}"
      DB_USERNAME: "${DB_USERNAME:-neondb_owner}"
      DB_PASSWORD: "${DB_PASSWORD}"
      NEON_ENDPOINT_ID: "${NEON_ENDPOINT_ID}"
      DATABASE_URL: "postgresql://${DB_USERNAME}:endpoint=${NEON_ENDPOINT_ID};${DB_PASSWORD}@${DB_HOST}/${DB_DATABASE}?sslmode=require&channel_binding=require"
    ports:
      - "${PORT:-10000}:10000"
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://localhost:${PORT}/healthz || exit 1" ]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - appnet

networks:
  appnet:
    driver: bridge
