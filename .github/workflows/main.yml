name: CI Runtime

on:
  pull_request:
  push:
    branches: [ main ]

env:
  CI_APP_PORT: "80"
  CI_DB_PORT: "3306"
  CI_WWWUSER: "1000"
  CI_WWWGROUP: "1000"
  CI_XDEBUG_MODE: "off"

jobs:
  smoke-dev:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' ||
      github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Node deps
        run: npm ci

      - name: Create .env from Github Actions secrets (dev)
        shell: bash
        run: |
          cat > .env <<'EOF'
          APP_PORT=${{ env.CI_APP_PORT }}

          APP_ENV=${{ secrets.APP_ENV }}
          APP_DEBUG=${{ secrets.APP_DEBUG }}
          APP_KEY=${{ secrets.APP_KEY }}
          APP_URL=${{ secrets.APP_URL }}

          DB_CONNECTION=${{ secrets.DB_CONNECTION }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=mysql
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}

          WWWUSER=${{ secrets.WWWUSER || env.CI_WWWUSER }}
          WWWGROUP=${{ secrets.WWWGROUP || env.CI_WWWGROUP }}

          SAIL_XDEBUG_MODE=${{ secrets.SAIL_XDEBUG_MODE }}
          EOF

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2

      - name: Install PHP deps
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Start dev stack
        run: npm run docker:dev:up

      - name: Dev HTTP smoke check
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:${{ env.CI_APP_PORT }} >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: Stop dev stack
        if: always()
        shell: bash
        run: |
          test -f .env || touch .env
          npm run docker:dev:down

  smoke-prod:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' ||
      github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Node deps
        run: npm ci

      - name: Create .env from GitHub Actions secrets (prod)
        shell: bash
        run: |
          cat > .env <<'EOF'
          APP_PORT=${{ env.CI_APP_PORT }}

          APP_ENV=${{ secrets.APP_ENV_PROD || secrets.APP_ENV }}
          APP_DEBUG=${{ secrets.APP_DEBUG_PROD || secrets.APP_DEBUG }}
          APP_KEY=${{ secrets.APP_KEY }}
          APP_URL=${{ secrets.APP_URL }}

          DB_CONNECTION=${{ secrets.DB_CONNECTION }}
          DB_HOST=db
          DB_PORT=${{ secrets.DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}

          WWWUSER=${{ secrets.WWWUSER }}
          WWWGROUP=${{ secrets.WWWGROUP }}

          SAIL_XDEBUG_MODE=${{ secrets.SAIL_XDEBUG_MODE }}
          EOF

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2

      - name: Install PHP dependencies (creates vendor/)
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Build prod image
        run: npm run docker:prod:build

      - name: Start prod stack
        run: npm run docker:prod:up

      - name: Prod HTTP smoke check
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:${{ env.CI_APP_PORT }} >/dev/null; then
              echo "Prod stack is respond on :${{ env.CI_APP_PORT }}"
              exit 0
            fi
            sleep 2
          done
          echo "Prod stack did not respond in time"
          exit 1

      - name: Stop prod stack
        if: always()
        shell: bash
        run: |
          test -f .env || touch .env
          npm run docker:prod:down
