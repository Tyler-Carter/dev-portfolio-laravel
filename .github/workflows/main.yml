name: CI Baseline

on:
  pull_request:
  push:
    branches: [ main ]

env:
  CI_APP_PORT: "80"
  CI_DB_PORT: "3306"
  CI_WWWUSER: "1000"
  CI_WWWGROUP: "1000"
  CI_XDEBUG_MODE: "off"

jobs:
  baseline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Node Dependencies (deterministic)
        run: npm ci

      - name: Capture npm audit (json + text)
        run: |
          mkdir -p audits
          npm audit --json > audits/npm-audit.json || true
          npm audit > audits/npm-audit.txt || true

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audits
          path: audits/

  smoke-dev:
    runs-on: ubuntu-latest
    needs: [baseline]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Node deps
        run: npm ci

      - name: Create .env from Github Actions secrets (dev)
        shell: bash
        run: |
          cat > .env <<'EOF'
          APP_PORT=${{ env.CI_APP_PORT }}

          APP_ENV=${{ secrets.APP_ENV }}
          APP_DEBUG=${{ secrets.APP_DEBUG }}
          APP_KEY=${{ secrets.APP_KEY }}
          APP_URL=${{ secrets.APP_URL }}

          DB_CONNECTION=${{ secrets.DB_CONNECTION }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT || env.CI_DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}

          WWWUSER=${{ secrets.WWWUSER || env.CI_WWWUSER }}
          WWWGROUP=${{ secrets.WWWGROUP || env.CI_WWWGROUP }}

          SAIL_XDEBUG_MODE=${{ secrets.SAIL_XDEBUG_MODE }}
          EOF

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2

      - name: Install PHP dependencies (creates vendor/)
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cach-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Start dev stack
        run: npm run docker:dev:up

      - name: Dev HTTP smoke check
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:${{ env.CI_APP_PORT }} >/dev/null; then
              echo "Dev stack is responding on :${{ env.CI_APP_PORT }}"
              exit 0
            fi
            sleep 2
          done
          echo "Dev stack did not respond in time"
          exit 1

      - name: Stop dev stack
        if: always()
        run: npm run docker:dev:down

      # Optional: artifact the generated env (sanitized) for debugging.
      # Keep disabled unless it is needed
      # it can leak values if not redacted.
      # - name: Debug env (DO NOT ENABLE unless redacting)
      #   if: false
      #   run: sed -E 's/(APP_KEY|DB_PASSWORD)=.*/\1=REDACTED/' .env

  smoke-prod:
    runs-on: ubuntu-latest
    needs: [baseline]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Node deps
        run: npm ci

      - name: Create .env from GitHub Actions secrets (prod)
        shell: bash
        run: |
          cat > .env <<'EOF'
          APP_PORT=${{ env.CI_APP_PORT }}

          APP_ENV=${{ secrets.APP_ENV_PROD || secrets.APP_ENV }}
          APP_DEBUG=${{ secrets.APP_DEBUG_PROD || secrets.APP_DEBUG }}
          APP_KEY=${{ secrets.APP_KEY }}
          APP_URL=${{ secrets.APP_URL }}

          DB_CONNECTION=${{ secrets.DB_CONNECTION }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}

          WWWUSER=${{ secrets.WWWUSER }}
          WWWGROUP=${{ secrets.WWWGROUP }}

          SAIL_XDEBUG_MODE=${{ secrets.SAIL_XDEBUG_MODE }}
          EOF

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2

      - name: Install PHP dependencies (creates vendor/)
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cach-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Build prod image
        run: npm run docker:prod:build

      - name: Start prod stack
        run: npm run docker:prod:up

      - name: Prod HTTP smoke check
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:${{ env.CI_APP_PORT }} >/dev/null; then
              echo "Prod stack is respond on :${{ env.CI_APP_PORT }}"
              exit 0
            fi
            sleep 2
          done
          echo "Prod stack did not respond in time"
          exit 1

      - name: Stop prod stack
        if: always()
        run: npm run docker:prod:down
