name: Deploy Production

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: ["main"]
  workflow_dispatch:

jobs:
  ci-gate:
    name: Verify CI succeeded
    runs-on: ubuntu-latest
    outputs:
      allow_deploy: ${{ steps.gate.outputs.allow_deploy }}

    steps:
      - name: Gate on CI workflow result
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const isWorkflowRun = context.eventName === 'workflow_run';
            if (isWorkflowRun) {
              const ok = context.payload.workflow_run?.conclusion === 'success';
              core.setOutput('allow_deploy', ok ? 'true' : 'false');
              if (!ok) {
                core.setFailed('Blocked: CI workflow did not succeed.');
              }
              return;
            }

            const { owner, repo } = context.repo;
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: 'ci.yml',
              branch: 'main',
              status: 'completed',
              per_page: 1,
            });

            const latest = runs.data.workflow_runs?.[0];
            if (!latest) {
              core.setOutput('allow_deploy', 'false');
              core.setFailed('Blocked: no completed CI run found on main.');
              return;
            }

            const ok = latest.conclusion === 'success';
            core.setOutput('allow_deploy', ok ? 'true' : 'false');
            if (!ok) {
              core.setFailed(`Blocked: latest CI run on main concluded as ${latest.conclusion}.`);
            }

  deploy-production:
    name: Run Render Migrations (production)
    needs: [ci-gate]
    if: ${{ needs.ci-gate.result == 'success' && needs.ci-gate.outputs.allow_deploy == 'true' }}
    runs-on: ubuntu-latest
    environment: production

    concurrency:
      group: deploy-production
      cancel-in-progress: false

    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install jq (required by migration job script)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Wait for Render production deploy to complete
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID || secrets.RENDER_SERVICE_ID }}
        run: |
          set -euo pipefail

          : "${RENDER_API_KEY:?Missing RENDER_API_KEY}"
          : "${RENDER_SERVICE_ID:?Missing RENDER_PRODUCTION_SERVICE_ID (or RENDER_SERVICE_ID fallback)}"

          api="https://api.render.com/v1"
          hdr=(-H "Accept: application/json" -H "Authorization: Bearer $RENDER_API_KEY")

          echo "Fetching latest deploy for service: $RENDER_SERVICE_ID"
          deploys_json="$(curl -sS "${hdr[@]}" "$api/services/$RENDER_SERVICE_ID/deploys")"

          deploy_id="$(
            echo "$deploys_json" \
              | jq -r 'sort_by(.deploy.createdAt) | reverse | .[0].deploy.id // empty'
          )"

          if [ -z "$deploy_id" ]; then
            echo "No deploys returned for service $RENDER_SERVICE_ID. Raw response:" >&2
            echo "$deploys_json" >&2
            exit 1
          fi

          echo "Latest deploy id: $deploy_id"

          timeout_s=1800
          sleep_s=10
          deadline=$(( $(date +%s) + timeout_s ))

          while true; do
            if [ "$(date +%s)" -ge "$deadline" ]; then
              echo "Timed out after ${timeout_s}s waiting for deploy $deploy_id" >&2
              exit 1
            fi

            deploys_json="$(curl -sS "${hdr[@]}" "$api/services/$RENDER_SERVICE_ID/deploys")"
            status="$(
              echo "$deploys_json" \
                | jq -r --arg id "$deploy_id" '.[] | select(.deploy.id == $id) | .deploy.status' \
                | head -n 1
            )"

            if [ -z "${status:-}" ] || [ "$status" = "null" ]; then
              echo "Could not find deploy $deploy_id in deploy list. Raw response:" >&2
              echo "$deploys_json" >&2
              exit 1
            fi

            if [ "$status" = "live" ]; then
              echo "Deploy is live."
              exit 0
            fi

            case "$status" in
              failed|canceled|cancelled|deactivated)
                echo "Deploy ended with status: $status" >&2
                exit 1
                ;;
            esac

            echo "Current status: $status; waiting ${sleep_s}s..."
            sleep "$sleep_s"
          done

      - name: Run Render one-off job migrations (production)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID || secrets.RENDER_SERVICE_ID }}
        run: |
          chmod +x ./render_run_migrations_job.sh
          ./render_run_migrations_job.sh
